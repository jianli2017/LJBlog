---
layout: post
title:  Mach-O Programming Topics 
category: 技术
comments: true
---


# 简介

　　　　
OSX X 支持多种应用程序，每种应用有自己的运行规则、约定、文件格式。在OS X中， kernel extensions, command-line tools, applications, frameworks, and libraries (shared and static) 使用Mach-O(mach object) 文件

OS X 运行时结构决定了对象文件在文件系统的布局、应用程序如何和内核交互。在OS X系统中对象文件（object file）的格式使用 Mach-O。

Mach-O格式文件有如下几个数据部分：

* header：指定了文件的构架，如PPC、PPC64、IA-32、x86-64。
* Load commands：指定了文件的逻辑结构、在虚拟内存（virtual memory）中文件的布局
* Raw segment data：包含在load commands中定义的段（segments）数据

# building Mach-O file

开发者通过将源码转化为对象文件（object file）可以创建程序。随后，可将对象文件打包为可执行代码或静态库。OSX提供的工具可以将源码转化为可以被使用者使用的应用或静态库。

本文讨论了Mac Apps 如何被编译， 深入讨论了我们可以编译的程序的种类。描述了Mach-O文件编译在过程中涉及的工具、解释了可以编译出的 Mach-O文件的种类、并谈到了模块（modules），模块是的代码和数据最小链接单元、也描述了静态库，静态库是模块的一个集合。

## 2.1 The Tools—Building and Running Mach-O Files（编译和运行 Mach-O文件的工具）

在运行时，内核使用动态链接器（dynamic linker，a specially marked dynamic shared library located at /usr/lib/dyld）去执行加载和绑定程序的工作。内核加载程序、动态链接为一个进程、并执行。

通过这篇文章，概况的说明下面的工具：

* compiler：将高级语言写的code翻译为包含机器二进制code和数据的中间对象文件。除非特别说明，本文将机器的编码当做compiler。

~~~
（assembler汇编程序;  汇编语言;  装配工;  低级编码）
（compiler 汇编者;  编辑者;  编纂者;  （电脑的）编译程序；编译）
~~~

* static linker：将中间的对象文件合并为最后的可执行程序

Xcode Tool包含很多命令行程序，这些工具可以编辑、分析应用程序。包括compilers、 ld、static linker。当你使用Xcode、标准的命令行工具、第三方的工具去开发应用程序，理解各个工具的作用有助于理解Mach-O运行结构、促进和其他的OS X 开发者交流。标准的工具包括如下：

~~~
facilitate 帮助;  促进，助长;  使容易
~~~ 

* The compiler driver 位于/usr/bin/gcc，可以编译，汇编、链接
* The C++ compiler driver 位于/usr/bin/c++
* The assembler 位于 /usr/bin/as 将汇编语言转化为中间对象文件
* The static linker 位于/usr/bin/ld ，用于合并Mach-O文件，可以使用static linker将程序链接为动态或静态的。静态的程序是完整的，他们不能调用其他的framework和库，只能系统条用他们。在OS X中，内核扩展是静态的，所有其他的程序都是动态的，即使是命令行程序，在内核外部调用内核是通过静态库，只有动态库可以访问静态库。
* he library creation tool 位于/usr/bin/libtool，根据参数创建静态库或动态库，When building shared libraries, libtool calls the static linker (ld).

分析Mach-O文件的工具如下：

* /usr/bin/lipo可以创建和分析包含多个框架镜像的二进制文件，例如在PowerPC、Intel-based机器上使用的通用二进制文件（universal binary）、PPC/PPC64 binary
* The file-type displaying tool, 位于/usr/bin/file，显示文件的类型，对于多构架的文件，它显示每个构架下的镜像类型。
* The object-file displaying tool，位于/usr/bin/otool，显示Mach-O 格式文件的sections、segments的内容。它包含各个构架下的符号
* The page-analysis tool, /usr/bin/pagestuff, displays information on each logical page that compose the image, including the names of the sections and symbols contained in each page. This tool doesn’t work on binaries containing images for more than one architecture.
* The symbol table display tool, /usr/bin/nm, allows you to view the contents of an object file’s symbol table.









